<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="https://use.fontawesome.com/9abde5d4d2.js"></script>
<script type="text/javascript" charset="utf-8" src="https://map.yahooapis.jp/js/V1/jsapi?appid=dj0zaiZpPUhvZkxuMlNYMkxjZSZzPWNvbnN1bWVyc2VjcmV0Jng9YmE-"></script>
<script src="js/request.js"></script>
<link rel="stylesheet" media="all" href="css/location.css" />
<title>附近的中华物产店</title>
</head>
<style type="text/css">
body {
	background-color: rgba(242, 242, 242, 0.46);
}
.title {
	background-color: #f2f2f2;
    padding: 10px;
    font-size: 110%;
    color: royalblue;
    /* box-shadow: 0 0px 8px 0 rgba(0,0,0,0.5),0 2px 10px 0 rgba(0,0,0,0.12)!important; */
    /* border-radius: 8px; */
    /* margin: 5px 0px; */
    /* border-bottom: 1px grey dotted; */
    margin: 2px 0;
    /* margin: 10px; */
}
.location_list {
	border-bottom: 1px solid grey;
	font-size: 85%;
}
#location {
	/*background-color: #f2f2f2;*/
	padding: 10px;
}
.location_name {
	display: inline-block;
}
.address {
	display: inline-block;
}
#share {
    position: fixed;
    right: 15px;
    bottom: 15px;
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    font-size: 15px;
    padding: 5px 15px;
    text-align: center;
}
#share:hover {
	font-size: 18px;
}
</style>
<script type="text/javascript">
// 現在所在地位置情報
var current_lat = 35.66572;
var current_lng = 139.73100;

// 地図で選択された位置情報
var selected_lat;
var selected_lng;

var map_displayed = false;

var icon = new Y.Icon('image/map-maker.svg',{iconSize: new Y.Size(60,60)});

window.onload = function(){

	// 現在地情報取得
	var option = {
		"enableHighAccuracy": false,
		"timeout": 5000,
		"maximumAge": 5000
	};
	var geoSuccess = function(pos) {
		current_lat = pos.coords.latitude;
		current_lng = pos.coords.longitude;
		showMap();
	};
	var geoError = function(pos) {
		// デフォルト設定
		current_lat = 35.66572;
		current_lng = 139.73100;
		showMap();
	};

	navigator.geolocation.getCurrentPosition(geoSuccess, geoError, option);

	var showMap = function(){

		if (map_displayed) {
			return;
		} else {
			map_displayed = true;
		}

		// Map描画サイズ設定
		var width = (window.innerWidth > 0) ? window.innerWidth : screen.width;
		$("#map").css("width", width);
		$("#map").css("height", width*0.8);

	    var ymap = new Y.Map("map",{
		    configure : {
		        doubleClickZoom : true,
		        scrollWheelZoom : true,
		        singleClickPan : true,
		        dragging : true
		    }
		});

	    // スマホスタイルに指定
	    ymap.setConfigure('mapType',Y.Map.TYPE.SMARTPHONE);
	    // 現在値の緯度
	    ymap.drawMap(new Y.LatLng(current_lat, current_lng), 17, Y.LayerSetId.NORMAL);

	    // 地図にアイコン表示
		var marker = new Y.Marker(new Y.LatLng(current_lat, current_lng), {icon: icon});

		// スケールコントロール追加
		ymap.addControl(new Y.SliderZoomControlVertical(), 
			new Y.ControlPosition(Y.ControlPosition.BOTTOM_LEFT, new Y.Size(10,230)));

		// 「大きな地図で見る」標識を隠す
		$(".yolp-ymapbanner").css("display","none");

		getLocationList(ymap);
	};

	var getLocationList = function(ymap) {
		request.ajax({
			url: "location_list.php",
	    	data: {
	    		lat: current_lat,
	    		lng: current_lng
	    	},
	    	success: function(response) {

	    		// 店舗なし、シェア
	    		if (Object.keys(response).length < 1) {
	    			$("#location").append("很抱歉，附近还没有店铺信息。我来分享");
	    		} else {
	    			for(var location_info of response.location_list) {
			    		$("#location").append(
			    			"<div class='location_list'>"
			                + "<div><div class='location_name'><div><i class='fa fa-map-marker' aria-hidden='true'></i>" 
			                + location_info.location_name + "</div>"
			                + "<div class='address'>" + location_info.address + "</div></div>"
			                + "<i class='fa fa-angle-right detail' aria-hidden='true'></i></div>"
			                + "<input type='hidden' value='" + location_info.location_id + "' name='location_id' />"
			                + "<input type='hidden' value='" + location_info.version_id + "' name='version_id' />"
			                + "<input type='hidden' value='" + location_info.lat + "' name='lat' />"
			                + "<input type='hidden' value='" + location_info.lng + "' name='lng' />"
			                + "<div>");
			    		// icon追加
			    		var marker = new Y.Marker(new Y.LatLng(location_info.lat, location_info.lng), {icon: icon});
						ymap.addFeature(marker);

						$("#location").on('click', '.location_list', function() {
							location_id = $(this).find("[name=location_id]").val();
							version_id = $(this).find("[name=version_id]").val();
							lat = $(this).find("[name=lat]").val();
							lng = $(this).find("[name=lng]").val();
							location.href = "location_info.html?location_id=" + location_id + "&version_id="
								+ version_id + "&lat=" + lat + "&lng=" + lng; 
						});
		    		}
	    		}

	   		}
		});
	};
};
</script>
<body>

<div class="header">
	<input type="text" id="keyword"　autocomplete="off" placeholder="東京都港区" ><button id="search" class="search">查找地点</button>
</div>

<div id="map">
	<div class="loading">
	    <div class="bar bar1"></div>
	    <div class="bar bar2"></div>
	    <div class="bar bar3"></div>
	    <div class="bar bar4"></div>
	    <div class="bar bar5"></div>
	</div>
	<div class="loading_footer">
		正在为您加载地图...	
	</div>
</div>

<div class="title"><i class="fa fa-flag" aria-hidden="true"></i>&nbsp;&nbsp;附近的店铺情报</div>
<div id="location">
</div>

<div id="share">
    <!--<i class="fa fa-plus-circle" aria-hidden="true"></i>-->
    我来分享<i class="fa fa-share-alt" aria-hidden="true"></i>
</div>

<script type="text/javascript">
$("#share").on('click', function(){
	location.href = "location_add.html";
});
</script>

</body>
</html>